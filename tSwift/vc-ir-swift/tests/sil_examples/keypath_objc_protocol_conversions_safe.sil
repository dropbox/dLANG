sil_stage canonical

import Builtin
import Swift
import SwiftShims

// Test file for keypath, objc_protocol, and unchecked ref/pointer conversions

protocol MyProto

struct Root {
  @_hasStorage var value: Int { get set }
}

class MyClass {
  @objc deinit
  init()
}

// Test function: objc_protocol + keypath
@_requires("true")
@_ensures("true")
func testObjcProtocolAndKeyPath() -> Int

sil hidden @testObjcProtocolAndKeyPath : $@convention(thin) () -> Int {
bb0:
  %0 = objc_protocol #MyProto : $Builtin.RawPointer
  %1 = keypath $KeyPath<Root, Int>, (root $Root; stored_property #Root.value : $Int)
  fix_lifetime %0 : $Builtin.RawPointer
  fix_lifetime %1 : $KeyPath<Root, Int>

  %2 = integer_literal $Builtin.Int64, 1
  %3 = struct $Int (%2)
  return %3 : $Int
}

// Test function: ref_to_unmanaged + unmanaged_to_ref
@_requires("true")
@_ensures("true")
func testUnmanagedConversion() -> Int

sil hidden @testUnmanagedConversion : $@convention(thin) () -> Int {
bb0:
  %0 = alloc_ref $MyClass
  %1 = ref_to_unmanaged %0 : $MyClass to $@sil_unmanaged MyClass
  %2 = unmanaged_to_ref %1 : $@sil_unmanaged MyClass to $MyClass
  strong_release %2 : $MyClass

  %3 = integer_literal $Builtin.Int64, 2
  %4 = struct $Int (%3)
  return %4 : $Int
}

// Test function: ref_to_raw_pointer + raw_pointer_to_ref
@_requires("true")
@_ensures("true")
func testRawPointerConversion() -> Int

sil hidden @testRawPointerConversion : $@convention(thin) () -> Int {
bb0:
  %0 = alloc_ref $MyClass
  %1 = ref_to_raw_pointer %0 : $MyClass to $Builtin.RawPointer
  %2 = raw_pointer_to_ref %1 : $Builtin.RawPointer to $MyClass
  strong_release %2 : $MyClass

  %3 = integer_literal $Builtin.Int64, 3
  %4 = struct $Int (%3)
  return %4 : $Int
}
