sil_stage canonical

import Builtin
import Swift
import SwiftShims

// castOrDefault: casts Animal to Dog, returns legs (4) if successful, default (2) otherwise
// With precondition that the casted value has non-negative legs,
// we can prove the postcondition result >= 0
@_requires("casted_0_Dog >= 0")
@_ensures("result >= 0")
func castOrDefault(_ animal: Animal) -> Int

class Animal {}
class Dog : Animal {}

// Implementation using checked_cast_br
sil hidden @$s17checked_cast_test13castOrDefaultySiAA6AnimalCF : $@convention(thin) (@guaranteed Animal) -> Int {
bb0(%0 : $Animal):
  debug_value %0, let, name "animal", argno 1
  checked_cast_br [exact] Animal in %0 : $Animal to Dog, bb1, bb2

bb1(%1 : $Dog):
  // Cast succeeded: %1 is the Dog
  // In real code, we'd access Dog properties
  // For verification, return symbolic casted value (legs = 4)
  %2 = integer_literal $Builtin.Int64, 4
  %3 = struct $Int (%2)
  return %3

bb2:
  // Cast failed: return default value (2 for bipeds)
  %4 = integer_literal $Builtin.Int64, 2
  %5 = struct $Int (%4)
  return %5
} // end sil function '$s17checked_cast_test13castOrDefaultySiAA6AnimalCF'
