sil_stage canonical

import Builtin
import Swift

// requiresAtMostTen: requires x <= 10
// This precondition will be verified as a CallPrecondition VC at call sites.
@_requires("x <= 10")
func requiresAtMostTen(_ x: Int) -> Int

// callWithHalf: calls requiresAtMostTen(a/2), precondition a/2 <= 10
// This tests DIVISION ARGUMENT EXPRESSION substitution in precondition obligations.
//
// Analysis:
// - Callee precondition: x <= 10
// - Call: requiresAtMostTen(a/2) where a/2 is computed via SIL builtin sdiv
// - Substituted obligation: (a/2) <= 10
// - Caller precondition: a/2 <= 10
// - With hypothesis a/2 <= 10, the call obligation is identical (QED)
@_requires("a / 2 <= 10")
func callWithHalf(_ a: Int) -> Int

// requiresAtMostTen implementation - identity function
sil hidden @$s17requires_div_args17requiresAtMostTenyS2iF : $@convention(thin) (Int) -> Int {
bb0(%0 : $Int):
  debug_value %0, let, name "x", argno 1
  return %0
} // end sil function '$s17requires_div_args17requiresAtMostTenyS2iF'

// callWithHalf implementation - computes a/2, then calls requiresAtMostTen(a/2)
sil hidden @$s17requires_div_args12callWithHalfyS2iF : $@convention(thin) (Int) -> Int {
bb0(%0 : $Int):
  debug_value %0, let, name "a", argno 1
  // Compute a/2
  %2 = struct_extract %0, #Int._value      // a._value
  %3 = integer_literal $Builtin.Int64, 2
  %4 = builtin "sdiv_Int64"(%2, %3) : $Builtin.Int64
  %5 = struct $Int (%4)                     // wrap as Int
  // Call requiresAtMostTen(a/2)
  %6 = function_ref @$s17requires_div_args17requiresAtMostTenyS2iF : $@convention(thin) (Int) -> Int
  %7 = apply %6(%5) : $@convention(thin) (Int) -> Int
  return %7
} // end sil function '$s17requires_div_args12callWithHalfyS2iF'
